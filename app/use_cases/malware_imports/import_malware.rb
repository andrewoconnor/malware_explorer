module MalwareImports
  class ImportMalware
    include UseCase

    def initialize(spreadsheet)
      @spreadsheet = spreadsheet
    end

    def perform
      import_csv if create_malware_import && columns_valid?
    end

    private

    attr_reader :malware_import, :spreadsheet, :csv, :column_index

    def create_malware_import
      @malware_import = MalwareImport.new(spreadsheet: spreadsheet)
      malware_import.save.tap do |success|
        errors.add(:base, malware_import.errors) unless success
      end
    end

    def csv
      @csv ||= Roo::Spreadsheet.open(
        @malware_import.spreadsheet.download,
        extension: :csv
      )
    end

    def header_columns
      csv.row(1)
    end

    def columns_valid?
      columns_recognized = header_columns & required_columns
      return true if columns_recognized.size == required_columns.size
      missing_columns = (required_columns - columns_recognized).to_sentence
      errors.add(:base, "Missing required columns: #{missing_columns}")
      false
    end

    def required_columns
      %w(MD5 ClassificationName ClassificationType Size FileType)
    end

    def column_index
      @column_index ||= required_columns.each_with_object({}) do |column, index|
        index[column] = header_columns.index(column)
      end
    end

    def classification(row)
      name = row[column_index['ClassificationName']]
      Classification.find_or_create_by(name: name)
    end

    def classification_type(row)
      name = row[column_index['ClassificationType']]
      ClassificationType.find_or_create_by(name: name)
    end

    def file_type(row)
      name = row[column_index['FileType']]
      FileType.find_or_create_by(name: name)
    end

    def md5(row)
      row[column_index['MD5']]
    end

    def size(row)
      row[column_index['Size']]
    end

    def create_malware(row)
      Malware.create(
        md5: md5(row),
        size: size(row),
        classification: classification(row),
        classification_type: classification_type(row),
        file_type: file_type(row),
        malware_import: malware_import
      )
    end

    def import_row(row)
      create_malware(row)
    end

    def import_csv
      ((csv.first_row + 1)..csv.last_row).each do |idx|
        row = csv.row(idx)
        import_row(row)
      end
    end
  end
end
