module MalwareImports
  class ImportMalware
    include UseCase

    def initialize(spreadsheet)
      @spreadsheet = spreadsheet
    end

    def perform
      import_csv if create_malware_import && columns_valid?
    end

    private

    attr_reader :malware_import, :spreadsheet, :csv, :column_indices

    def create_malware_import
      @malware_import = MalwareImport.new(spreadsheet: spreadsheet)
      malware_import.save.tap do |success|
        errors.add(:base, malware_import.errors.full_messages[0]) unless success
      end
    end

    def csv
      @csv ||= Roo::Spreadsheet.open(
        @malware_import.spreadsheet.download,
        extension: :csv
      )
    end

    def header_columns
      csv.row(1)
    end

    def columns_valid?
      columns_found = header_columns & required_columns
      return true if columns_found.size == required_columns.size
      missing_columns = (required_columns - columns_found).to_sentence
      errors.add(:base, "Missing required columns: #{missing_columns}")
      false
    end

    def required_columns
      %w(MD5 ClassificationName ClassificationType Size FileType)
    end

    def column_indices
      @column_indices ||= required_columns.each_with_object({}) do |column, idx|
        idx[column] = header_columns.index(column)
      end
    end

    def find_or_create_obj(column_name, row, klass)
      name = row[column_indices[column_name]]
      Rails.cache.fetch("#{klass}/#{name}", expires_in: 12.hours) do
        klass.find_or_create_by(name: name)
      end
    end

    def classification(row)
      column_name = 'ClassificationName'
      find_or_create_obj(column_name, row, Classification)
    end

    def classification_type(row)
      column_name = 'ClassificationType'
      find_or_create_obj(column_name, row, ClassificationType)
    end

    def file_type(row)
      column_name = 'FileType'
      find_or_create_obj(column_name, row, FileType)
    end

    def md5(row)
      row[column_indices['MD5']]
    end

    def size(row)
      row[column_indices['Size']]
    end

    def create_malware(row)
      Malware.create(
        md5: md5(row),
        size: size(row),
        classification: classification(row),
        classification_type: classification_type(row),
        file_type: file_type(row),
        malware_import: malware_import
      )
    end

    def import_row(row)
      return if Malware.where(md5: md5(row)).first
      create_malware(row)
    end

    def import_csv
      ((csv.first_row + 1)..csv.last_row).each do |idx|
        row = csv.row(idx)
        import_row(row)
      end
    end
  end
end
