require 'rails_helper'

describe MalwareImports::ImportMalware do

  describe '#perform' do
    let(:csv) { valid_csv }

    subject(:use_case) { MalwareImports::ImportMalware.perform(csv) }

    it 'creates a malware import record' do
      expect { use_case }.to change { MalwareImport.count }.by 1
    end

    it 'creates classification records' do
      expect { use_case }.to change { Classification.count }.by 2
    end

    it 'creates classification type records' do
      expect { use_case }.to change { ClassificationType.count }.by 2
    end

    it 'creates file type records' do
      expect { use_case }.to change { FileType.count }.by 2
    end

    it 'creates malware records' do
      expect { use_case }.to change { Malware.count }.by 3
    end
  end

  describe 'errors' do
    let(:csv) { csv_missing_columns }

    subject(:use_case) { MalwareImports::ImportMalware.perform(csv) }

    it 'has missing columns error' do
      error_msg = 'Missing required columns: ClassificationType, Size, and FileType'
      expect(use_case.errors.full_messages.to_sentence).to eq error_msg
    end
  end
end
