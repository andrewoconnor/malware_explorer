RSpec.describe MalwareImports::ImportMalware do
  describe '#perform' do
    let(:valid_rows) do
      <<-eos.gsub(/^[\s\t]*/, '')
      MD5,ClassificationName,ClassificationType,Size,FileType
      0x962B49E6E03493E7C2C65ABDE0A26F90,Downloader,trojan,6604,exe
      0x8C494881AD677D531320B6E42566C66B,Windows,clean,176128,exe
      0x08507D36FFF750ED5C921F23EFA03137,Windows,clean,2161,dll
      eos
    end

    let(:test_csv) { Tempfile.new(['test_csv', '.csv']) }

    let(:valid_csv) do
      test_csv.write(valid_rows)
      test_csv.rewind
      Rack::Test::UploadedFile.new(test_csv, 'text/csv')
    end

    subject(:use_case) { MalwareImports::ImportMalware.perform(valid_csv) }

    it 'creates a malware import record' do
      expect { use_case }.to change { MalwareImport.count }.by 1
    end

    it 'creates two classification records' do
      expect { use_case }.to change { Classification.count }.by 2
    end

    it 'creates two classification type records' do
      expect { use_case }.to change { ClassificationType.count }.by 2
    end

    it 'creates two file type records' do
      expect { use_case }.to change { FileType.count }.by 2
    end

    it 'creates three malware records' do
      expect { use_case }.to change { Malware.count }.by 3
    end
  end
end
